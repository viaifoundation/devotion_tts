# Dockerfile for Fun-CosyVoice 3.0 on NVIDIA DGX Spark (ARM64/Blackwell)
# Supports zero-shot voice cloning with 0.5B parameter model

FROM nvcr.io/nvidia/pytorch:25.11-py3

# Set working directory
WORKDIR /workspace/github/devotion_tts

# Install system dependencies
RUN apt-get update && apt-get install -y \
    ffmpeg \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install CosyVoice dependencies
# NOTE: onnxruntime-gpu not available for ARM64, using CPU version for text frontend
# Install CosyVoice 3.0 dependencies
# Match packages from setup_cosy3_spark.sh
# Install CosyVoice dependencies
# Explicitly uninstall conflicting packages
RUN pip uninstall -y huggingface-hub transformers 2>/dev/null

# Tier 1: Safe Utilities (Install with dependencies)
RUN pip install --no-cache-dir \
    "numpy<2.0" \
    coloredlogs \
    flatbuffers \
    einx \
    loguru \
    tqdm \
    "typing-extensions" \
    PyYAML \
    pynvml \
    "fsspec<=2025.10.0" \
    gdown \
    hydra-core \
    inflect \
    omegaconf \
    pyworld \
    pydub \
    matplotlib \
    protobuf \
    rich \
    "ruamel.yaml<0.18.0" \
    tiktoken \
    pydantic \
    wget \
    mutagen \
    packaging \
    regex \
    safetensors \
    tokenizers \
    psutil

# Tier 2: AI Core (Install with NO DEPS to prevent torch downgrade)
# Warning: Do NOT remove --no-deps or torch will be downgraded!
RUN pip install --no-cache-dir --no-deps \
    "transformers==4.46.3" \
    "huggingface-hub<1.0" \
    "pytorch-lightning>=2.0.0" \
    "torchmetrics>=0.7.0" \
    accelerate \
    diffusers \
    HyperPyYAML \
    conformer \
    lightning \
    modelscope \
    openai-whisper \
    x-transformers \
    onnx \
    onnxruntime \
    librosa \
    soundfile

# Remove requirements copy since we installed everything above
# COPY requirements-cosy-spark.txt /tmp/requirements-cosy-spark.txt
# RUN pip install -r /tmp/requirements-cosy-spark.txt

# Set environment for CosyVoice
ENV PYTHONPATH="/workspace/github/CosyVoice:/workspace/github/CosyVoice/third_party/Matcha-TTS"

# Create model directory
RUN mkdir -p /workspace/github/CosyVoice/pretrained_models/Fun-CosyVoice3-0.5B

# Download Fun-CosyVoice 3.0 model during build (optional, can also mount)
# Uncomment below to bake model into image (increases image size by ~10GB)
# RUN huggingface-cli download FunAudioLLM/Fun-CosyVoice3-0.5B-2512 \
#     --local-dir /workspace/github/CosyVoice/pretrained_models/Fun-CosyVoice3-0.5B

# Default command
CMD ["/bin/bash"]
